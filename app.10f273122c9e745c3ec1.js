(()=>{"use strict";(()=>{function e(e,t){let i=document.querySelector("#viewing"),s=e.youtubeUrl.split("=")[1];return e.player.setVideoId(s),i}const t=new RegExp("^(https://[a-zA-Z]+.youtube.com)");function i(e){return e&&t.test(e)}function s(e,t){let s=document.querySelector("#picking").content.cloneNode(!0),a=s.querySelector("input"),n=s.querySelector("#open-video"),o=s.querySelector("#error");return a.oninput=e=>{const t=a.value;a.classList.remove("invalid"),a.classList.remove("valid"),n.classList.remove("valid"),i(t)?(n.removeAttribute("disabled"),o.innerHTML="",o.style.marginBottom="0",o.style.marginTop="0",a.style.color="black",n.classList.add("valid"),a.classList.add("valid")):(o.innerHTML="This is an invalid youtube video url",o.style.marginBottom="16px",o.style.marginTop="5px",n.setAttribute("disabled","disabled"),a.classList.add("invalid"),a.style.color="red")},n.onclick=e=>{let i=a.value;t({type:"youtube-url-changed",payload:i})},s}function a(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0),s=i.querySelector("label");return e.youtubeUrl?s.innerHTML=`Video is being synchronized with ${e.initializer.clientName}`:s.innerHTML=`${e.initializer.clientName} is picking a video to share`,i}class n{constructor(e){this.kosyClient=window.parent,this.latestMessageNumber=0,this.kosyApp=e}dictionaryToArray(e){let t=[];for(const i in e)e.hasOwnProperty(i)&&t.push([i,e[i]]);return t}startApp(){return this.initialInfoPromise=new Promise(((e,t)=>{window.addEventListener("message",(t=>{let i=t.data;switch(i.type){case"receive-initial-info":this.latestMessageNumber=i.latestMessageNumber,this.clients=i.payload.clients,this.hostClientUuid=i.payload.initializerClientUuid,this.log("Resolving initial info promise with: ",i.payload),e(i.payload);break;case"set-client-info":{let e=i.clients,t=i.hostClientUuid;this.initialInfoPromise.then((i=>{let s=this.dictionaryToArray(e).filter((e=>!this.clients[e[0]])),a=this.dictionaryToArray(this.clients).filter((t=>!e[t[0]])),n=this.latestMessageNumber;this.hostClientUuid!==t&&this._relayMessageToClients(i,{type:"_host-has-changed",clientUuid:t},++n),s.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-joined",clientInfo:e[1]},++n))),a.forEach((e=>this._relayMessageToClients(i,{type:"_client-has-left",clientUuid:e[0]},++n))),this.clients=e,this.hostClientUuid=t}));break}case"get-app-state":{let e=i.clientUuids;this.log("Get app state received -> sending app state");const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",state:t,clientUuids:e,latestMessageNumber:this.latestMessageNumber});break}case"set-app-state":this.latestMessageNumber=i.latestMessageNumber;let t=i.state;this.initialInfoPromise.then((()=>{this.log("Received app state from Kosy -> setting app state"),this.kosyApp.onProvideState(t)}));break;case"receive-message-as-host":this._handleReceiveMessageAsHost(i);break;case"receive-message-as-client":this._handleReceiveMessageAsClient(i)}})),this._sendMessageToKosy({type:"ready-and-listening"})})),this.initialInfoPromise}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this.log("Relaying client message to host: ",e),this._sendMessageToKosy({type:"relay-message-to-host",message:e})}_relayMessageToClients(e,t,i){this.log("Relaying host to client message: ",t),this._sendMessageToKosy({type:"relay-message-to-clients",sentByClientUuid:e.currentClientUuid,message:t,messageNumber:i})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}_handleReceiveMessageAsClientRecursive(e,t,i){var s,a,n,o,r,l;if(this.latestMessageNumber===e.messageNumber-1){switch(e.message.type){case"_host-has-changed":{let t=e.message.clientUuid;this.hostClientUuid=t,null===(a=(s=this.kosyApp).onHostHasChanged)||void 0===a||a.call(s,t);break}case"_client-has-joined":{let t=e.message.clientInfo;this.clients[t.clientUuid]=t,null===(o=(n=this.kosyApp).onClientHasJoined)||void 0===o||o.call(n,t);break}case"_client-has-left":{let t=e.message.clientUuid;this.clients[t]=null,null===(l=(r=this.kosyApp).onClientHasLeft)||void 0===l||l.call(r,t);break}default:this.kosyApp.onReceiveMessageAsClient(e.message)}this.latestMessageNumber=e.messageNumber}else i<50&&this.latestMessageNumber<e.messageNumber?setTimeout((()=>this._handleReceiveMessageAsClientRecursive(e,t,i+1)),100):(this.log("Timeout on processing message as client: ",e.message),this.log("Wait for Kosy to fix this mess..."))}_handleReceiveMessageAsClient(e){this.initialInfoPromise.then((t=>{this.log("Received message as client, processing: ",e.message),this._handleReceiveMessageAsClientRecursive(e,t,0)}))}_handleReceiveMessageAsHost(e){this.initialInfoPromise.then((t=>{this.log("Trying to handle message as host");const i=this.kosyApp.onReceiveMessageAsHost(e.message);i&&this._relayMessageToClients(t,i,this.latestMessageNumber+1)}))}log(...e){"1"===localStorage.getItem("debug-mode")&&console.log("From kosy-app-api: ",...e)}}var o=function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}l((s=s.apply(e,t||[])).next())}))};class r{constructor(e,t,i,s){this.videoId=e,this.isHost=t,this.dispatch=i,this.appState=s,this.gettingCurrentStateAndTime=!1,this.previousSyncTime=new Date}setVideoId(e){return o(this,void 0,void 0,(function*(){return this.videoId=e,this.userHasInteractedWithVideo=!1,this.playerPromise=new Promise(((t,i)=>{let s=new YT.Player("viewing",{width:window.innerWidth,height:window.innerHeight,videoId:e,events:{onReady:()=>o(this,void 0,void 0,(function*(){t(s),(yield this.getIframe()).classList.add("overlay")})),onStateChange:e=>{this.onStateChange(s)}},playerVars:{enablejsapi:1,fs:1,rel:0,modestbranding:1,showinfo:1,start:this.appState.time,controls:this.isHost?1:0}})})),this.playerPromise}))}onStateChange(e){this.isHost&&!this.userHasInteractedWithVideo?(this.userHasInteractedWithVideo=!0,this.interval=window.setInterval((()=>{this.gettingCurrentStateAndTime||(this.gettingCurrentStateAndTime=!0,this.getCurrentStateAndTime(e),this.gettingCurrentStateAndTime=!1)}),500)):this.userHasInteractedWithVideo||(this.userHasInteractedWithVideo=!0,this.dispatch({type:"request-youtube-video-state"}))}getIframe(){return o(this,void 0,void 0,(function*(){return(yield this.playerPromise).getIframe()}))}getCurrentState(){return o(this,void 0,void 0,(function*(){return(yield this.playerPromise).getPlayerState()}))}getCurrentTime(){return o(this,void 0,void 0,(function*(){return(yield this.playerPromise).getCurrentTime()}))}handleStateChange(e,t){return o(this,void 0,void 0,(function*(){if(this.playerPromise&&this.userHasInteractedWithVideo){let i=yield this.playerPromise;switch(null!=e?e:YT.PlayerState.UNSTARTED){case YT.PlayerState.PLAYING:case YT.PlayerState.UNSTARTED:case YT.PlayerState.CUED:i.playVideo();break;case YT.PlayerState.PAUSED:i.pauseVideo();break;case YT.PlayerState.ENDED:console.log("Video ended")}let s=i.getCurrentTime();if(s&&t&&Math.abs(s-t)<=1)return;i.seekTo(null!=t?t:0,!0)}}))}getCurrentStateAndTime(e){return o(this,void 0,void 0,(function*(){let t=e.getPlayerState(),i=e.getCurrentTime(),s=this.appState.videoState,a=this.appState.time;this.appState.videoState=t,this.appState.time=i,(s!=t||Math.abs(i-a)>2||(new Date).valueOf()-this.previousSyncTime.valueOf()>5e3)&&(this.previousSyncTime=new Date,this.dispatch({type:"youtube-video-state-changed",payload:{state:t,time:i}}),t==YT.PlayerState.ENDED&&null!=this.interval&&clearInterval(this.interval))}))}}var l,h=function(e,t,i,s){return new(i||(i=Promise))((function(a,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function r(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,r)}l((s=s.apply(e,t||[])).next())}))};!function(t){var o;(function(t){class o{constructor(){this.state={youtubeUrl:null,videoState:null},this.kosyApi=new n({onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessageAsClient:e=>this.processMessage(e),onReceiveMessageAsHost:e=>this.processMessageAsHost(e),onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e;return h(this,void 0,void 0,(function*(){yield this.setupPlayerScript();let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.player=new r(null,this.initializer.clientUuid==this.currentClient.clientUuid,(e=>this.processComponentMessage(e)),this.state),this.viewState=t.currentClientUuid==t.initializerClientUuid?"picking":"waiting",this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))}))}setupPlayerScript(){return h(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{window.onYouTubeIframeAPIReady=()=>e();const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";const s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(i,s)}))}))}setState(e){this.state=e,this.renderComponent()}getState(){return this.state}onClientHasLeft(e){e===this.initializer.clientUuid&&(this.state.youtubeUrl?this.kosyApi.relayMessage({type:"assign-new-host"}):this.kosyApi.stopApp())}processMessage(e){switch(e.type){case"close-integration":this.kosyApi.stopApp();break;case"receive-youtube-url":i(e.payload)&&(this.state.youtubeUrl=`${e.payload}`,this.currentClient.clientUuid===this.initializer.clientUuid&&(this.viewState="viewing"),this.renderComponent());break;case"receive-youtube-video-state":this.currentClient.clientUuid===this.initializer.clientUuid||"viewing"!==this.viewState&&e.payload.state!=YT.PlayerState.PLAYING||(this.viewState="viewing",this.player.handleStateChange(e.payload.state,e.payload.time),this.state.videoState=e.payload.state,this.state.time=e.payload.time,this.renderComponent()),this.state.videoState==YT.PlayerState.ENDED&&(console.log("Video ended, clearing youtube url"),this.state.youtubeUrl=null,this.state.videoState=null,this.kosyApi.stopApp())}}processMessageAsHost(e){switch(e.type){case"assign-new-host":this.renderComponent();break;case"request-youtube-video-state":return{type:"receive-youtube-video-state",payload:{state:this.state.videoState,time:this.state.time}};default:return e}return null}processComponentMessage(e){switch(e.type){case"close-integration":this.kosyApi.relayMessage({type:"close-integration"});break;case"youtube-url-changed":this.kosyApi.relayMessage({type:"receive-youtube-url",payload:e.payload});break;case"youtube-video-state-changed":this.kosyApi.relayMessage({type:"receive-youtube-video-state",payload:e.payload});break;case"request-youtube-video-state":this.kosyApi.relayMessage(e)}}renderComponent(){!function(t,i){let n,o=document.getElementById("root"),r=null==t.videoState||null==t.player.videoId;switch(t.viewState){case"picking":n=s;break;case"viewing":n=e;break;case"waiting":n=a}if(r&&null!=n){console.log("App is redrawn");var l=o.cloneNode(!1);o.parentNode.replaceChild(l,o),l.appendChild(n(t,i))}}({youtubeUrl:this.state.youtubeUrl,videoState:this.state.videoState,time:this.state.time,currentClient:this.currentClient,initializer:this.initializer,player:this.player,viewState:this.viewState},(e=>this.processComponentMessage(e)))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}t.App=o,(new o).start()})((o=t.Integration||(t.Integration={})).Youtube||(o.Youtube={}))}(l||(l={}))})()})();